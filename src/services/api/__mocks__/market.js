const orderBuy1 = {
  deferred_fee: 578,
  expiration: '2019-04-05T15:34:23',
  for_sale: 14734920,
  id: '1.7.62250477',
  sell_price: {
    base: {
      amount: 14734920,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 55769,
      asset_id: '1.3.850'
    }
  },
  seller: '1.2.132834'
};

const orderBuy2 = {
  deferred_fee: 578,
  expiration: '2023-04-05T15:32:43',
  for_sale: 50607694,
  id: '1.7.62250393',
  sell_price: {
    base: {
      amount: 50607694,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 191664,
      asset_id: '1.3.850'
    }
  },
  seller: '1.2.493448'
};

const orderBuy3 = {
  deferred_fee: 578,
  expiration: '2023-04-04T15:34:31',
  for_sale: 52802994,
  id: '1.7.62250482',
  sell_price: {
    base: {
      amount: 52802994,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 200000,
      asset_id: '1.3.850'
    }
  },
  seller: '1.2.126225'
};

const orderBuy4 = {
  deferred_fee: 578,
  expiration: '2019-04-05T14:16:21',
  for_sale: 1552408,
  id: '1.7.62243769',
  sell_price: {
    base: {
      amount: 1552408,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 5880,
      asset_id: '1.3.850'
    }
  },
  seller: '1.2.376918'
};

const orderBuy5 = {
  deferred_fee: 578,
  expiration: '2023-04-05T14:07:21',
  for_sale: 10000000,
  id: '1.7.62243039',
  sell_price: {
    base: {
      amount: 10000000,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 37915,
      asset_id: '1.3.850'
    }
  },
  seller: '1.2.429491'
};


const orderSell1 = {
  deferred_fee: 578,
  expiration: '2023-04-05T15:38:50',
  for_sale: 3602966,
  id: '1.7.62250730',
  sell_price: {
    base: {
      amount: 4000000,
      asset_id: '1.3.850'
    },
    quote: {
      amount: 1066400000,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.354664'
};

const orderSell2 = {
  deferred_fee: 0,
  expiration: '2023-04-05T14:48:21',
  for_sale: 18308,
  id: '1.7.62246651',
  sell_price: {
    base: {
      amount: 49903,
      asset_id: '1.3.850'
    },
    quote: {
      amount: 13319110,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.502341'
};

const orderSell3 = {
  deferred_fee: 0,
  expiration: '2018-04-20T18:46:31',
  for_sale: 136333,
  id: '1.7.62240965',
  sell_price: {
    base: {
      amount: 234500,
      asset_id: '1.3.850'
    },
    quote: {
      amount: 62879843,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.1310'
};

const orderSell4 = {
  deferred_fee: 578,
  expiration: '2019-04-05T12:46:40',
  for_sale: 139561,
  id: '1.7.62236557',
  sell_price: {
    base: {
      amount: 139561,
      asset_id: '1.3.850'
    },
    quote: {
      amount: 38435099,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.549541'
};

const orderSell5 = {
  deferred_fee: 578,
  expiration: '2018-04-12T06:56:56',
  for_sale: 181540,
  id: '1.7.62204518',
  sell_price: {
    base: {
      amount: 181540,
      asset_id: '1.3.850'
    },
    quote: {
      amount: 50000000,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.770077'
};

const buyCNYOrder1 = {
  deferred_fee: 578,
  expiration: '2018-04-16T04:51:23',
  for_sale: 9900243,
  id: '1.7.62559913',
  sell_price: {
    base: {
      amount: 9900243,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 835364,
      asset_id: '1.3.113'
    }
  },
  seller: '1.2.602724'
};
const buyCNYOrder2 = {
  deferred_fee: 578,
  expiration: '2019-04-09T04:51:15',
  for_sale: 1385078692,
  id: '1.7.62559882',
  sell_price: {
    base: {
      amount: 1385078692,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 116873184,
      asset_id: '1.3.113'
    }
  },
  seller: '1.2.613598'
};
const buyCNYOrder3 = {
  deferred_fee: 578,
  expiration: '2019-04-09T04:51:34',
  for_sale: 99997110,
  id: '1.7.62559926',
  sell_price: {
    base: {
      amount: 99997110,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 8437813,
      asset_id: '1.3.113'
    }
  },
  seller: '1.2.455122'
};
const buyCNYOrder4 = {
  deferred_fee: 578,
  expiration: '2019-04-09T04:52:00',
  for_sale: 262908748,
  id: '1.7.62559979',
  sell_price: {
    base: {
      amount: 262908748,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 22184484,
      asset_id: '1.3.113'
    }
  },
  seller: '1.2.473486'
};
const buyCNYOrder5 = {
  deferred_fee: 578,
  expiration: '2019-04-09T04:51:29',
  for_sale: 695497517,
  id: '1.7.62559918',
  sell_price: {
    base: {
      amount: 695497517,
      asset_id: '1.3.0'
    },
    quote: {
      amount: 58691909,
      asset_id: '1.3.113'
    }
  },
  seller: '1.2.469235'
};

const sellCNYOrder1 = {
  deferred_fee: 578,
  expiration: '2023-04-09T04:54:51',
  for_sale: 34274045,
  id: '1.7.62560294',
  sell_price: {
    base: {
      amount: 34274045,
      asset_id: '1.3.113'
    },
    quote: {
      amount: 408998146,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.129515'
};

const sellCNYOrder2 = {
  deferred_fee: 578,
  expiration: '2019-04-09T04:52:25',
  for_sale: 655700,
  id: '1.7.62560027',
  sell_price: {
    base: {
      amount: 655700,
      asset_id: '1.3.113'
    },
    quote: {
      amount: 7850560,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.860552'
};

const sellCNYOrder3 = {
  deferred_fee: 578,
  expiration: '2019-04-09T04:47:03',
  for_sale: 199999609,
  id: '1.7.62559463',
  sell_price: {
    base: {
      amount: 199999609,
      asset_id: '1.3.113'
    },
    quote: {
      amount: 2394660000,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.613598'
};

const sellCNYOrder4 = {
  deferred_fee: 578,
  expiration: '2019-04-09T04:41:36',
  for_sale: 50000,
  id: '1.7.62558919',
  sell_price: {
    base: {
      amount: 50000,
      asset_id: '1.3.113'
    },
    quote: {
      amount: 598717,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.851645'
};

const sellCNYOrder5 = {
  deferred_fee: 578,
  expiration: '2019-04-09T04:41:36',
  for_sale: 500000,
  id: '1.7.62558924',
  sell_price: {
    base: {
      amount: 500000,
      asset_id: '1.3.113'
    },
    quote: {
      amount: 5987179,
      asset_id: '1.3.0'
    }
  },
  seller: '1.2.824732'
};

const ordersArray = {
  '1.3.850': [orderBuy1, orderSell5, orderSell4, orderBuy2, orderSell3, orderBuy3, orderSell2, orderSell1, orderBuy4, orderBuy5],
  '1.3.113': [buyCNYOrder1, buyCNYOrder2, sellCNYOrder1, buyCNYOrder3, sellCNYOrder2, sellCNYOrder3, sellCNYOrder4, buyCNYOrder4, sellCNYOrder5, buyCNYOrder5]
};

const loadLimitOrders = async (baseId, quoteId, limit = 500) => {
  const orders = ordersArray[quoteId];
  const buyOrders = [];
  const sellOrders = [];
  orders.forEach((order) => {
    if (order.sell_price.base.asset_id === baseId) {
      buyOrders.push(order);
    } else {
      sellOrders.push(order);
    }
  });
  return new Promise((resolve) => {
    resolve({ buyOrders, sellOrders });
  });
};

const calcOrderRate = (order) => {
  const {
    sell_price: {
      quote: {
        amount: quoteAmount
      },
      base: {
        amount: baseAmount
      }
    }
  } = order;
  return baseAmount / quoteAmount;
};

const distributionFromBalances = (balances) => {
  const total = Object.keys(balances).reduce((res, key) => res + balances[key], 0);
  return Object.keys(balances).reduce(
    (res, key) => Object.assign(res, { [key]: balances[key] / total }),
    {}
  );
};

const getValuesToUpdate = (balances, baseBalances, update) => {
  const totalBase = Object.keys(baseBalances).reduce((res, key) => res + baseBalances[key], 0);
  const distribution = distributionFromBalances(baseBalances);

  const result = {
    sell: {},
    buy: {}
  };

  Object.keys(update).forEach((assetId) => {
    if (assetId === '1.3.0') return;
    const futureShare = update[assetId];
    const currentShare = distribution[assetId];

    console.log('CALC VALUES:', assetId);
    console.log(futureShare);
    console.log(currentShare);


    if (futureShare === 0) {
      result.sell[assetId] = balances[assetId];
    } else if (futureShare > currentShare) {
      const futureBase = Math.floor(totalBase * futureShare);
      const currentBase = Math.floor(totalBase * currentShare);
      result.buy[assetId] = futureBase - currentBase;
    } else {
      const fullAmmountInCurrent = Math.floor(balances[assetId] / currentShare);
      const amountInFuture = Math.floor(fullAmmountInCurrent * futureShare);
      const otherPortfolioAmount = fullAmmountInCurrent - balances[assetId];
      const amountToSell = fullAmmountInCurrent - otherPortfolioAmount - amountInFuture;
      result.sell[assetId] = amountToSell;
    }
  });
  return result;
};

const createOrder = ({ sell, receive, userId, fillOrKill = false }) => {
  return {
    seller: userId,
    amount_to_sell: sell,
    min_to_receive: receive,
    fill_or_kill: fillOrKill
  };
};

class Market {
  constructor(base) {
    this.base = base;
    this.markets = {};
    this.fee = 578;
  }

  getFee() {
    return this.fee;
  }

  setDefaultObjects(assetId) {
    if (!this.markets[assetId]) {
      this.markets[assetId] = {
        orders: {
          buy: [], sell: []
        },
        callback: () => {}
      };
    }
  }

  async subscribeToMarket(assetId, callback) {
    if (assetId === this.base) return;
    const { buyOrders, sellOrders } = await loadLimitOrders(this.base, assetId);
    this.setDefaultObjects(assetId);
    // console.log('setting default: ' + assetId + ' : ', this.markets[assetId]);
    this.markets[assetId].orders.buy = buyOrders;
    console.log('buyOrders', buyOrders);
    this.markets[assetId].orders.sell = sellOrders;
    console.log('sellOrders', sellOrders);
    this.markets[assetId].callback = callback;
    callback();
  }

  calcExchangeRate(assetId, weWantTo, amount) {
    let totalPay = amount;
    let totalReceive = 0;

    const requiredType = (weWantTo === 'sell') ? 'buy' : 'sell';
    // console.log('cakc exchange rate for ' + assetId + ': ', this.markets[assetId]);
    const orders = [...this.markets[assetId].orders[requiredType]].sort((a, b) =>
      calcOrderRate(b) - calcOrderRate(a));
    for (let i = 0; i < orders.length; i += 1) {
      const { for_sale: saleAmount, sell_price: price } = orders[i];
      const orderPrice = price.base.amount / price.quote.amount;
      const weCanPayHere = saleAmount / orderPrice;

      if (totalPay > weCanPayHere) {
        totalReceive += saleAmount;
        totalPay -= weCanPayHere;
      } else {
        totalReceive += totalPay * orderPrice;
        break;
      }
    }
    return Math.floor(totalReceive);
  }

  async subscribeToExchangeRate(assetId, amount, callback) {
    let canReceiveInBasePrev = 0;
    const wrappedCallback = () => {
      const canReceiveInBase = this.calcExchangeRate(assetId, 'sell', amount);
      if (canReceiveInBase !== canReceiveInBasePrev && canReceiveInBase > 0) {
        canReceiveInBasePrev = canReceiveInBase;
        callback(assetId, canReceiveInBase);
      }
    };
    await this.subscribeToMarket(assetId, wrappedCallback);
  }

  isSubscribed(assetId) {
    return (this.markets[assetId] !== undefined);
  }

  unsubscribeFromExchangeRate(assetId) {
    this.unsubscribeFromMarket(assetId);
  }

  unsubscribeFromMarket(assetId) {
    if (this.isSubscribed(assetId)) {
      delete this.markets[assetId];
    }
  }


  generateOrders({ update, balances, baseBalances, userId }) {
    console.log('GENERATE ORDERS');
    console.log('update', update);
    console.log('balances', balances);
    console.log('baseBalances', baseBalances);
    const calculated = getValuesToUpdate(balances, baseBalances, update);
    const sellOrders = [];
    const buyOrders = [];

    Object.keys(calculated.sell).forEach((assetId) => {
      const toSell = calculated.sell[assetId];
      // if (!toSell) return;
      let toReceive = this.calcExchangeRate(assetId, 'sell', toSell);
      const fee = this.getFee(assetId);
      if (toReceive > fee) {
        toReceive -= fee;
        const orderObject = {
          sell: {
            asset_id: assetId,
            amount: toSell
          },
          receive: {
            asset_id: this.base,
            amount: toReceive
          },
          userId,
          fillOrKill: true
        };
        const order = createOrder(orderObject);

        sellOrders.push(order);
      }
    });

    // console.log('sell orders: ', sellOrders);


    Object.keys(calculated.buy).forEach((assetId) => {
      let toSellBase = calculated.buy[assetId];
      const fee = this.getFee(assetId);
      if (toSellBase > fee) {
        toSellBase -= fee;
        const toReceive = this.calcExchangeRate(assetId, 'buy', toSellBase);
        if (!toReceive) return;
        const orderObject = {
          sell: {
            asset_id: this.base,
            amount: toSellBase
          },
          receive: {
            asset_id: assetId,
            amount: toReceive
          },
          userId
        };
        const order = createOrder(orderObject);
        buyOrders.push(order);
      }
    });

    console.log('buy orders: ', buyOrders);
    console.log('sell orders', sellOrders);
    return {
      sellOrders,
      buyOrders
    };
  }
}

const markets = {};
markets['1.3.0'] = new Market('1.3.0');

export default markets;
